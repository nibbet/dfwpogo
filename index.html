<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DFW Area Pokemon GO - Community Events</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="header">
        <h1>DFW Area
            Pokemon GO</h1>
        <p>Your guide to local community events and Campfire groups</p>
    </div>

    <div class="container">
        <div class="nav-container">
            <button class="mobile-nav-toggle" onclick="toggleMobileNav()">
                <span class="current-tab">ðŸ“… Events</span>
                <span class="hamburger">â˜°</span>
            </button>
            <div class="nav-tabs" id="nav-tabs">
                <button class="tab-btn active" onclick="showTab('events', 'ðŸ“… Events')">ðŸ“… Events</button>
                <button id="signature-tab-btn" class="tab-btn" onclick="showTab('signature', 'ðŸŒŸ Signature Events')">ðŸŒŸ Signature Events</button>
                <button class="tab-btn" onclick="showTab('campfire', 'ðŸ”¥ Campfire Groups')">ðŸ”¥ Campfire Groups</button>
            </div>
        </div>

        <div class="content-area">
            <div id="events-tab" class="tab-content">
                <h2>Upcoming Events</h2>
                <div id="events-list" class="event-grid">
                    <div class="loading">Loading events...</div>
                </div>
            </div>

            <div id="signature-tab" class="tab-content" style="display:none;">
                <div id="signature-content" class="markdown-content">
                    <div class="loading">Loading signature event...</div>
                </div>
            </div>

            <div id="campfire-tab" class="tab-content" style="display:none;">
                <h2>Local Campfire Groups</h2>
                <div id="campfire-list" class="markdown-content">
                    <div class="loading">Loading Campfire groups...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // MAINTENANCE MODE - Change to true to enable
        // ==========================================
        const MAINTENANCE_MODE = false;
        
        let eventsData = [];
        let campfireData = '';
        let signatureData = '';
        let signatureTitle = localStorage.getItem('lastSignatureTitle') || 'Signature Events';

        // Constants for localStorage
        const STORAGE_KEYS = {
            TITLE: 'lastSignatureTitle',
            LAST_UPDATED: 'signatureTitleLastUpdated'
        };

        // Cache duration (24 hours in milliseconds)
        const CACHE_DURATION = 24 * 60 * 60 * 1000;

        // Load markdown files from GitHub
        async function loadMarkdownFile(filename) {
            try {
                const response = await fetch(filename);
                if (!response.ok) {
                    throw new Error(`Failed to load ${filename}`);
                }
                return await response.text();
            } catch (error) {
                console.error(`Error loading ${filename}:`, error);
                return null;
            }
        }

        function parseEvents(markdown) {
            if (!markdown) return [];
            
            const events = [];
            const sections = markdown.split('##').filter(s => s.trim());
            
            sections.forEach(section => {
                const lines = section.trim().split('\n');
                const title = lines[0].trim();
                const content = lines.slice(1).join('\n');
                
                const dateMatch = content.match(/\*\*Date:\*\*\s*(.+)/);
                const pokemonMatch = content.match(/\*\*Featured Pokemon:\*\*\s*(.+)/);
                const typeMatch = content.match(/\*\*Type:\*\*\s*(.+)/);
                
                events.push({
                    title,
                    date: dateMatch ? dateMatch[1].trim() : 'TBA',
                    pokemon: pokemonMatch ? pokemonMatch[1].trim() : '',
                    type: typeMatch ? typeMatch[1].trim().toLowerCase().replace(/\s+/g, '-') : 'event',
                    content: marked.parse(content)
                });
            });
            
            return events;
        }

        function parseSignatureEvent(markdown) {
            if (!markdown || !markdown.trim()) {
                hideSignatureTab();
                return '';
            }
            
            // Extract title from first h1
            const titleMatch = markdown.match(/^#\s+(.+)$/m);
            if (titleMatch) {
                const newTitle = titleMatch[1].trim();
                updateSignatureTitle(newTitle);
                showSignatureTab();
            } else {
                // Try to use cached title if available and not expired
                const cachedTitle = getCachedTitle();
                if (cachedTitle) {
                    signatureTitle = cachedTitle;
                    updateSignatureTabLabel();
                    showSignatureTab();
                } else {
                    hideSignatureTab();
                }
            }
            return marked.parse(markdown);
        }

        function updateSignatureTitle(newTitle) {
            signatureTitle = newTitle;
            // Cache the new title
            localStorage.setItem(STORAGE_KEYS.TITLE, newTitle);
            localStorage.setItem(STORAGE_KEYS.LAST_UPDATED, Date.now().toString());
            updateSignatureTabLabel();
        }

        function getCachedTitle() {
            const lastUpdated = parseInt(localStorage.getItem(STORAGE_KEYS.LAST_UPDATED) || '0');
            const cachedTitle = localStorage.getItem(STORAGE_KEYS.TITLE);
            
            // Check if cache exists and isn't expired
            if (cachedTitle && Date.now() - lastUpdated < CACHE_DURATION) {
                return cachedTitle;
            }
            
            // Clear expired cache
            localStorage.removeItem(STORAGE_KEYS.TITLE);
            localStorage.removeItem(STORAGE_KEYS.LAST_UPDATED);
            return null;
        }

        function updateSignatureTabLabel() {
            const tabBtn = document.getElementById('signature-tab-btn');
            if (!tabBtn) return;
            
            // Shorten title if it's too long
            const displayTitle = signatureTitle.length > 25 
                ? signatureTitle.substring(0, 22) + '...' 
                : signatureTitle;
            tabBtn.innerHTML = `ðŸŒŸ ${displayTitle}`;
            tabBtn.setAttribute('onclick', `showTab('signature', 'ðŸŒŸ ${displayTitle}')`);
        }

        function hideSignatureTab() {
            const tabBtn = document.getElementById('signature-tab-btn');
            if (tabBtn) {
                tabBtn.classList.add('hiding');
                // Wait for transition before hiding
                setTimeout(() => {
                    tabBtn.style.display = 'none';
                    tabBtn.classList.remove('hiding');
                    // If signature tab was active, switch to events tab
                    if (tabBtn.classList.contains('active')) {
                        showTab('events', 'ðŸ“… Events');
                    }
                }, 300); // Match transition duration
            }
            const signatureTab = document.getElementById('signature-tab');
            if (signatureTab) {
                signatureTab.style.display = 'none';
            }
        }

        function showSignatureTab() {
            const tabBtn = document.getElementById('signature-tab-btn');
            if (tabBtn) {
                // Reset visibility without transition
                tabBtn.classList.remove('hiding');
                tabBtn.style.opacity = '0';
                tabBtn.style.display = '';
                
                // Trigger transition
                requestAnimationFrame(() => {
                    tabBtn.style.opacity = '1';
                });
            }
        }

        function renderEvents() {
            const container = document.getElementById('events-list');
            
            if (eventsData.length === 0) {
                container.innerHTML = '<div class="error">No events found. Please ensure events.md exists in your repository.</div>';
                return;
            }
            
            container.innerHTML = eventsData.map(event => `
                <div class="event-card">
                    <span class="event-type type-${event.type}">${event.type.replace('-', ' ').toUpperCase()}</span>
                    <h3>${event.title}</h3>
                    <p><strong>ðŸ“… ${event.date}</strong></p>
                    ${event.pokemon ? `<p>âš¡ Featured: ${event.pokemon}</p>` : ''}
                    <div class="markdown-content">${event.content}</div>
                </div>
            `).join('');
        }

        function renderSignature() {
            const container = document.getElementById('signature-content');
            
            if (!signatureData) {
                container.innerHTML = '<div class="error">No signature event found. Please ensure signature.md exists in your repository.</div>';
                return;
            }
            
            container.innerHTML = `<div class="signature-card">${signatureData}</div>`;
        }

        function renderCampfire() {
            const container = document.getElementById('campfire-list');
            
            if (!campfireData) {
                container.innerHTML = '<div class="error">No Campfire groups found. Please ensure campfire.md exists in your repository.</div>';
                return;
            }
            
            container.innerHTML = marked.parse(campfireData);
        }

        function showTab(tabName, tabLabel) {
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.style.display = 'none');
            
            const buttons = document.querySelectorAll('.tab-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(`${tabName}-tab`).style.display = 'block';
            
            // Find and activate the clicked button
            const clickedButton = Array.from(buttons).find(btn => 
                btn.getAttribute('onclick') && btn.getAttribute('onclick').includes(tabName)
            );
            if (clickedButton) {
                clickedButton.classList.add('active');
            }

            // Update mobile nav toggle text
            const mobileToggle = document.querySelector('.mobile-nav-toggle .current-tab');
            if (mobileToggle && tabLabel) {
                mobileToggle.textContent = tabLabel;
            }

            // Close mobile nav after selection
            closeMobileNav();
        }

        function toggleMobileNav() {
            const navTabs = document.getElementById('nav-tabs');
            navTabs.classList.toggle('mobile-open');
        }

        function closeMobileNav() {
            const navTabs = document.getElementById('nav-tabs');
            navTabs.classList.remove('mobile-open');
        }

        // Close mobile nav when clicking outside
        document.addEventListener('click', function(event) {
            const navContainer = document.querySelector('.nav-container');
            const navTabs = document.getElementById('nav-tabs');
            
            if (!navContainer.contains(event.target) && navTabs.classList.contains('mobile-open')) {
                closeMobileNav();
            }
        });

        // Initialize - Load all markdown files
        async function init() {
            // Load events
            const eventsMarkdown = await loadMarkdownFile('events.md');
            if (eventsMarkdown) {
                eventsData = parseEvents(eventsMarkdown);
                renderEvents();
            }

            // Load signature event
            const signatureMarkdown = await loadMarkdownFile('signature.md');
            signatureData = parseSignatureEvent(signatureMarkdown || '');
            if (signatureData) {
                renderSignature();
            }

            // Load campfire groups
            const campfireMarkdown = await loadMarkdownFile('campfire.md');
            if (campfireMarkdown) {
                campfireData = campfireMarkdown;
                renderCampfire();
            }
        }

        // Load content when page loads
        // Initialize sticky mobile nav behavior
        function setupStickyMobileNav() {
            const navContainer = document.querySelector('.nav-container');
            if (!navContainer) return;

            let navTop = navContainer.getBoundingClientRect().top + window.scrollY;

            function updateNav() {
                // Only use sticky behavior on narrow viewports
                if (window.innerWidth > 768) {
                    navContainer.classList.remove('fixed');
                    document.body.classList.remove('nav-fixed');
                    document.body.style.removeProperty('--nav-height');
                    return;
                }

                const navHeight = navContainer.getBoundingClientRect().height;
                // Save nav height to a CSS variable so we can pad content
                document.body.style.setProperty('--nav-height', `${navHeight}px`);

                if (window.scrollY > navTop) {
                    if (!navContainer.classList.contains('fixed')) {
                        navContainer.classList.add('fixed');
                        document.body.classList.add('nav-fixed');
                    }
                } else {
                    if (navContainer.classList.contains('fixed')) {
                        navContainer.classList.remove('fixed');
                        document.body.classList.remove('nav-fixed');
                    }
                }
            }

            // Recalculate anchor position on resize/paint
            function recompute() {
                navTop = navContainer.getBoundingClientRect().top + window.scrollY;
                updateNav();
            }

            window.addEventListener('scroll', updateNav, { passive: true });
            window.addEventListener('resize', recompute);
            // run once to set initial state
            recompute();
        }

        init();
        setupStickyMobileNav();
    </script>
    <footer class="site-footer">
        <div class="container">
            <a class="discord-btn sticky" href="https://discord.gg/Yc6rg2a5xe" target="_blank" rel="noopener noreferrer" aria-label="Join our Discord server">Join our Discord Server</a>
        </div>
    </footer>
</body>
</html>
