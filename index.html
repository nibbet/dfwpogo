<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="google-adsense-account" content="ca-pub-7375087964799588">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="dfwstyle.css">
  <link rel="apple-touch-icon" href="/img/apple-touch-icon.png" />
  <meta name="theme-color" content="#cc0000" />
  <!-- Open Graph Meta Tags for Discord Embed -->
  <meta property="og:title" content="DFW Area Pokémon GO Community" />
  <meta property="og:description" content="Join epic meetups and catch ‘em all across DFW!" />
  <meta property="og:image" content="https://dfwpogo.com/img/social-preview.png" />
  <meta property="og:url" content="https://dfwpogo.com" />
  <meta property="og:type" content="website" /> 
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="DFW Area Pokémon GO Community" />
  <meta name="twitter:description" content="Check in and join the fun across DFW!" />
  <meta name="twitter:image" content="https://dfwpogo.com/img/social-preview.png" />
  <title>DFW Area Pokémon GO</title>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7375087964799588"
     crossorigin="anonymous"></script>
</head>
<body>
  <header id="main-header">
    <h1>DFW Area Pokémon GO</h1>
  </header>

  <main>
    <div class="tabs" role="tablist" aria-label="Main Tabs" id="main-tabs">
      <!-- Dynamic tab will be inserted first by JS -->
      <button class="tab-button" onclick="showTab('weekdayevents', event)" role="tab" aria-selected="false">Weekday Events</button>
      <button class="tab-button" onclick="showTab('weekendevents', event)" role="tab" aria-selected="false">Weekend Events</button>
      <button class="tab-button" onclick="showTab('communities', event)" role="tab" aria-selected="false">Communities</button>
    </div>
    <div id="swipe-area">
      <!-- Dynamic tab content will be inserted first by JS -->
      <div id="weekdayevents" class="tab-content"><div id="weekdayevents-container"></div></div>
      <div id="weekendevents" class="tab-content"><div id="weekendevents-container"></div></div>
      <div id="communities" class="tab-content">
        <ul id="community-list"></ul>
      </div>
    </div>
  </main>

  <div style="display: flex; justify-content: center; margin-top: 1em;">
    <a href="https://discord.gg/YTNmVde6Vg" target="_blank" class="link-button-blue" style="display: flex; align-items: center;">
      <img src="img/discord.png" alt="Discord" class="button-icon" style="margin-right: 0.5em;">Join Our Discord
    </a>
  </div>

  <footer>
    Created for DFW Trainers
  </footer>

  <script src="js/communities.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    // Tab IDs and markdown file mapping
    const tabIds = [
      // dynamic tab will be inserted first if present
      'weekdayevents',
      'weekendevents',
      'communities'
    ];
    const tabMarkdownFiles = {
      weekdayevents: 'weekdayevents.md',
      weekendevents: 'weekendevents.md'
    };

    // Dynamic tab config
    const dynamicMdFile = 'dynamic.md';

    // Insert dynamic tab first if markdown has content
    fetch(dynamicMdFile)
      .then(response => response.text())
      .then(md => {
        if (!md.trim()) return; // No data, do not show tab
        // Get first H1 as tab label
        const h1Match = md.match(/^#\s+(.+)$/m);
        if (!h1Match) return;
        const tabLabel = h1Match[1].trim();

        // Insert tab button as first
        const tabsDiv = document.getElementById('main-tabs');
        const btn = document.createElement('button');
        btn.className = 'tab-button active';
        btn.setAttribute('role', 'tab');
        btn.setAttribute('aria-selected', 'true');
        btn.textContent = tabLabel;
        btn.onclick = function(e) { showTab('dynamic', e); };
        tabsDiv.insertBefore(btn, tabsDiv.firstChild);

        // Insert tab content as first
        const swipeArea = document.getElementById('swipe-area');
        const tabDiv = document.createElement('div');
        tabDiv.id = 'dynamic';
        tabDiv.className = 'tab-content active';
        const container = document.createElement('div');
        container.id = 'dynamic-container';
        tabDiv.appendChild(container);
        swipeArea.insertBefore(tabDiv, swipeArea.firstChild);

        // Make all other tabs inactive
        document.querySelectorAll('.tab-button').forEach((b, i) => {
          if (i > 0) {
            b.classList.remove('active');
            b.setAttribute('aria-selected', 'false');
          }
        });
        document.querySelectorAll('.tab-content').forEach((c, i) => {
          if (i > 0) c.classList.remove('active');
        });

        tabIds.unshift('dynamic');
        renderMarkdownSections(md, container);
      });

    // Load markdown for each tab except communities and dynamic
    Object.entries(tabMarkdownFiles).forEach(([tabId, mdFile]) => {
      const container = document.getElementById(tabId + '-container');
      if (!container) return;
      fetch(mdFile)
        .then(response => response.text())
        .then(md => renderMarkdownSections(md, container))
        .catch(() => {
          const errorDiv = document.createElement('div');
          errorDiv.textContent = 'Failed to load info for this tab.';
          container.appendChild(errorDiv);
        });
    });

    // Markdown rendering helper
    function renderMarkdownSections(md, container) {
      const lines = md.split('\n');
      let sections = [];
      let currentTitle = '';
      let currentContent = [];
      let intro = [];
      let currentLevel = 0;
      lines.forEach(line => {
        if (line.startsWith('# ')) {
          // H1: render as non-collapsible
          if (currentTitle) {
            sections.push({ title: currentTitle, content: currentContent.join('\n'), level: currentLevel });
          }
          currentTitle = line.replace(/^#\s*/, '').trim();
          currentContent = [];
          currentLevel = 1;
          sections.push({ title: currentTitle, content: '', level: 1 });
          currentTitle = '';
        } else if (line.startsWith('## ')) {
          if (currentTitle) {
            sections.push({ title: currentTitle, content: currentContent.join('\n'), level: currentLevel });
          }
          currentTitle = line.replace(/^##\s*/, '').trim();
          currentContent = [];
          currentLevel = 2;
        } else if (line.startsWith('### ')) {
          if (currentTitle) {
            sections.push({ title: currentTitle, content: currentContent.join('\n'), level: currentLevel });
          }
          currentTitle = line.replace(/^###\s*/, '').trim();
          currentContent = [];
          currentLevel = 3;
        } else {
          if (!currentTitle && sections.length === 0) {
            intro.push(line);
          } else {
            currentContent.push(line);
          }
        }
      });
      if (currentTitle) {
        sections.push({ title: currentTitle, content: currentContent.join('\n'), level: currentLevel });
      }
      if (intro.length) {
        const introDiv = document.createElement('div');
        introDiv.className = 'markdown-intro';
        introDiv.innerHTML = marked.parse(intro.join('\n'));
        container.appendChild(introDiv);
      }
      sections.forEach(sec => {
        if (sec.level === 1) {
          // Non-collapsible H1
          const h1 = document.createElement('h1');
          h1.textContent = sec.title;
          container.appendChild(h1);
        } else if (sec.level === 2) {
          // Non-collapsible H2
          const h2 = document.createElement('h2');
          h2.textContent = sec.title;
          container.appendChild(h2);
          if (sec.content) {
            const contentDiv = document.createElement('div');
            contentDiv.className = 'markdown-section';
            contentDiv.innerHTML = marked.parse(sec.content);
            container.appendChild(contentDiv);
          }
        } else if (sec.level === 3) {
          // Collapsible H3
          const details = document.createElement('details');
          const summary = document.createElement('summary');
          summary.textContent = sec.title;
          details.appendChild(summary);
          if (sec.content) {
            const contentDiv = document.createElement('div');
            contentDiv.className = 'markdown-section';
            contentDiv.innerHTML = marked.parse(sec.content);
            details.appendChild(contentDiv);
          }
          container.appendChild(details);
        }
      });
    }

    let currentTab = 0;
    function showTab(tabId, event) {
      const tabs = document.querySelectorAll('.tab-content');
      const buttons = document.querySelectorAll('.tab-button');
      tabs.forEach(tab => tab.classList.remove('active'));
      buttons.forEach((btn, idx) => {
        btn.classList.remove('active');
        btn.setAttribute('aria-selected', 'false');
        if (tabIds[idx] === tabId) {
          btn.classList.add('active');
          btn.setAttribute('aria-selected', 'true');
        }
      });
      document.getElementById(tabId).classList.add('active');
      currentTab = tabIds.indexOf(tabId);
    }

    // Scoped swipe detection
    const swipeArea = document.getElementById('swipe-area');
    let touchStartX = 0;
    let touchEndX = 0;

    swipeArea.addEventListener('touchstart', function(e) {
      touchStartX = e.changedTouches[0].screenX;
    });

    swipeArea.addEventListener('touchend', function(e) {
      touchEndX = e.changedTouches[0].screenX;
      const delta = touchEndX - touchStartX;
      if (Math.abs(delta) > 50) {
        if (delta < 0 && currentTab < tabIds.length - 1) {
          showTab(tabIds[currentTab + 1]);
        } else if (delta > 0 && currentTab > 0) {
          showTab(tabIds[currentTab - 1]);
        }
      }
    });

    // Pull-to-refresh implementation
    let startY = 0;
    let isPulling = false;
    let refreshElem = null;
    function createRefreshElem() {
      if (!refreshElem) {
        refreshElem = document.createElement('div');
        refreshElem.style.position = 'fixed';
        refreshElem.style.top = '0';
        refreshElem.style.left = '0';
        refreshElem.style.right = '0';
        refreshElem.style.height = '40px';
        refreshElem.style.background = '#cc0000';
        refreshElem.style.color = '#fff';
        refreshElem.style.display = 'flex';
        refreshElem.style.alignItems = 'center';
        refreshElem.style.justifyContent = 'center';
        refreshElem.style.fontWeight = 'bold';
        refreshElem.style.zIndex = '9999';
        refreshElem.style.transform = 'translateY(-40px)';
        refreshElem.style.transition = 'transform 0.2s';
        refreshElem.innerText = '↻ Refreshing...';
        document.body.appendChild(refreshElem);
      }
    }
    window.addEventListener('touchstart', function(e) {
      if (window.scrollY === 0) {
        startY = e.touches[0].clientY;
        isPulling = true;
      }
    });
    window.addEventListener('touchmove', function(e) {
      if (!isPulling) return;
      const currentY = e.touches[0].clientY;
      if (currentY - startY > 60) {
        createRefreshElem();
        refreshElem.style.transform = 'translateY(0)';
      }
    });
    window.addEventListener('touchend', function(e) {
      if (refreshElem && refreshElem.style.transform === 'translateY(0px)') {
        setTimeout(() => {
          location.reload();
        }, 400);
      }
      if (refreshElem) {
        refreshElem.style.transform = 'translateY(-40px)';
      }
      isPulling = false;
    });

    // Dynamic header content based on device
    function updateHeaderForDevice() {
      const header = document.getElementById('main-header');
      if (!header) return;
      if (window.innerWidth <= 600) {
        header.innerHTML = `<h1 style="font-size:1.3em;">DFW Area Pokémon GO</h1>`;
      } else {
        header.innerHTML = `<h1>DFW Area Pokémon</h1>
          <p>Join us for epic Pokémon GO adventures in the Dallas-Fort Worth area!</p>`;
      }
    }
    window.addEventListener('DOMContentLoaded', updateHeaderForDevice);
    window.addEventListener('resize', updateHeaderForDevice);

    // Register service worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js')
        .then(reg => console.log('Service Worker registered!', reg))
        .catch(err => console.log('Service Worker registration failed:', err));
    }
  </script>
</body>
</html>
